<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IoT Realtime Dashboard</title>

  <!-- SignalR client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f5f5f5;
    }
    h2 {
      color: #0078d4;
    }
    .status-bar {
      background: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .telemetry-display {
      background: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      max-width: 800px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
    }
    .alert {
      background: #ff4444;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 5px 0;
    }
    .metrics {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .metric {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
      text-align: center;
    }
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #0078d4;
    }
    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
  </style>
</head>
<body>

  <h2>üöÄ IoT Realtime Telemetry Dashboard</h2>
  
  <div class="status-bar">
    <strong>Connection Status:</strong> <span id="status">Connecting...</span>
    <span style="margin-left: 20px;"><strong>Last Update:</strong> <span id="lastUpdate">Never</span></span>
    <span style="margin-left: 20px;"><strong>Messages Received:</strong> <span id="messageCount">0</span></span>
  </div>

  <div class="metrics">
    <div class="metric">
      <div class="metric-value" id="temperature">--</div>
      <div class="metric-label">Temperature (¬∞C)</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="humidity">--</div>
      <div class="metric-label">Humidity (%)</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="battery">--</div>
      <div class="metric-label">Battery (%)</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="deviceStatus">--</div>
      <div class="metric-label">Device Status</div>
    </div>
  </div>

  <div id="alerts"></div>

  <h3>üìä Raw Telemetry Data</h3>
  <pre class="telemetry-display" id="output">Waiting for data...</pre>

  <script>
    // URL t·ªõi Function App c·ªßa b·∫°n
    const FUNCTION_BASE_URL = "https://iot-realtime-fn-bya4dsg6eue0dkcv.eastus-01.azurewebsites.net";
    let messageCount = 0;

    async function start() {
      // 1Ô∏è‚É£ Get SignalR connection info
      const negotiateResponse = await fetch(
        `${FUNCTION_BASE_URL}/api/negotiate`
      );
      const connectionInfo = await negotiateResponse.json();
      console.log("üîó Connection info received:", connectionInfo);

      // 2Ô∏è‚É£ Create SignalR connection
      const connection = new signalR.HubConnectionBuilder()
        .withUrl(connectionInfo.url, {
          accessTokenFactory: () => connectionInfo.accessToken
        })
        .withAutomaticReconnect()
        .configureLogging(signalR.LogLevel.Information)
        .build();

      // 3Ô∏è‚É£ Receive telemetry (ƒë√∫ng t√™n event l√† telemetryUpdate)
      connection.on("telemetryUpdate", data => {
        console.log("üì° Received telemetry data:", data);
        // Update message count
        messageCount++;
        document.getElementById("messageCount").textContent = messageCount;
        document.getElementById("lastUpdate").textContent = new Date().toLocaleTimeString();

        // Support both formats: alerts in root or in data
        let telemetry = data;
        if (data && data.data) {
          telemetry = data.data;
        }
        document.getElementById("temperature").textContent = telemetry.temperature || '--';
        document.getElementById("humidity").textContent = telemetry.humidity || '--';
        document.getElementById("battery").textContent = telemetry.battery || '--';
        document.getElementById("deviceStatus").textContent = telemetry.status || '--';

        // Display alerts
        let alerts = telemetry.alerts || data.alerts || [];
        if (alerts.length > 0) {
          const alertsDiv = document.getElementById("alerts");
          alertsDiv.innerHTML = '<h3>‚ö†Ô∏è Active Alerts</h3>';
          alerts.forEach(alert => {
            const alertDiv = document.createElement("div");
            alertDiv.className = "alert";
            alertDiv.textContent = `${alert.level ? alert.level.toUpperCase() : ''}: ${alert.message}`;
            alertsDiv.appendChild(alertDiv);
          });
        } else {
          document.getElementById("alerts").innerHTML = '';
        }

        // Display raw data
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      });

      // Add more event listeners for debugging
      connection.onreconnecting((error) => {
        console.log("üîÑ SignalR reconnecting:", error);
        document.getElementById("status").textContent = "Reconnecting...";
      });

      connection.onreconnected((connectionId) => {
        console.log("‚úÖ SignalR reconnected:", connectionId);
        document.getElementById("status").textContent = "Connected ‚úÖ";
      });

      connection.onclose((error) => {
        console.log("‚ùå SignalR connection closed:", error);
        document.getElementById("status").textContent = "Disconnected ‚ùå";
      });

      // 4Ô∏è‚É£ Start connection
      await connection.start();
      console.log("üéØ SignalR connection started successfully");
      document.getElementById("status").textContent = "Connected ‚úÖ";
    }

    start().catch(err => {
      console.error("üí• Connection error:", err);
      document.getElementById("status").textContent = "Error ‚ùå";
    });
  </script>

</body>
</html>
